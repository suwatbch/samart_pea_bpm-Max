//----------------------------------------------------------------------------------------
// patterns & practices - Smart Client Software Factory - Guidance Package
//
// This file was generated by the "Add View" recipe.
//
// This class is the concrete implementation of a View in the Model-View-Presenter 
// pattern. Communication between the Presenter and this class is acheived through 
// an interface to facilitate separation and testability.
// Note that the Presenter generated by the same recipe, will automatically be created
// by CAB through [CreateNew] and bidirectional references will be added.
//
// For more information see:
// ms-help://MS.VSCC.v80/MS.VSIPCC.v80/ms.scsf.2006jun/SCSF/html/03-030-Model%20View%20Presenter%20%20MVP%20.htm
//
// Latest version of this Guidance Package: http://go.microsoft.com/fwlink/?LinkId=62182
//----------------------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.Windows.Forms;
using System.Globalization;
using Microsoft.Practices.CompositeUI.WinForms;
using Microsoft.Practices.CompositeUI.SmartParts;
using Microsoft.Practices.ObjectBuilder;
using PEA.BPM.Infrastructure.Interface;
using PEA.BPM.AgencyManagementModule.Views;
using PEA.BPM.AgencyManagementModule.Interface.BusinessEntities;
using PEA.BPM.Architecture.CommonUtilities;
using System.Threading;
using PEA.BPM.AgencyManagementModule.Utilities;
using System.Collections;
using PEA.BPM.Architecture.ArchitectureTool.Security;
using PEA.BPM.AgencyManagementModule.Interface.Constants;
using System.Drawing;
using PEA.BPM.Architecture.ArchitectureTool;

namespace PEA.BPM.AgencyManagementModule
{
    [SmartPart]
    public partial class BillBookSearchView : UserControl, IBillBookSearchView
    {
        private DateTimeFormatInfo _th_dt;
        private DateTimeFormatInfo _us_dt;
        private LineSearchInfo _focusedLine;       
        private BookHolderState _bookHolderState;
        private AgentInfo _agentInfo;
        private string _receiveCount;
        private BillBookHeaderInfo _bookHeader;
        private IBillBookManagementView _billBookMgtView;
        private decimal? _usedDeposit;
        private CalenderHelper _calendar;
        private bool _isEditBillBook = false;
        private bool _keydownEvent = false;        
      
        public void SetCancelBillBook (bool enable)
        {        
            billPeriodText.Enabled = !enable;
            agentIdText.Enabled = !enable;
        }

        public BillBookSearchView()
        {
            InitializeComponent();
            CultureInfo th_culture = new CultureInfo("th-TH");
            CultureInfo us_culture = new CultureInfo("en-US");
            _th_dt = th_culture.DateTimeFormat;
            _us_dt = us_culture.DateTimeFormat;
            _focusedLine = new LineSearchInfo();
            _bookHolderState = BookHolderState.Agent;
            _calendar = new CalenderHelper();
            advancePaymentDateText.Enabled = true;
            _isEditBillBook = false;
        }

        public AgentInfo SearchAgentInfo
        {
            set 
            { 
                _agentInfo = value;
                FillAgentInfomation(_agentInfo);               
            }
        }


        public void FocusEmployeeInput()
        {
            controllerIdText.Clear();
            controllerIdText.Focus();
        }

        public IBillBookManagementView BillBookMgtView
        {
            set { _billBookMgtView = value; }
        }

        public string ControllerId
        {
            get { return this.controllerIdText.Text.Trim(); }
        }

        public string ReceiveCount
        {
            set
            {
                _receiveCount = value;
                receiveCountText.Text = _receiveCount;
                controllerIdText.Focus();
            }
        }

        public string BillPeriod
        {
            set { billPeriodText.Text = value; }
            get { return billPeriodText.Text; }
        }

        public void EnableReceiveCount(bool enable)
        {
            receiveCountText.Enabled = enable;
        }
    
        public void FocusReceiveCount()
        {
            receiveCountText.Focus();
            receiveCountText.SelectAll();
        }

        public void FocusCancelBillBook()
        {
            cancelBillBookIdTb.Focus();
            cancelBillBookIdTb.SelectAll();
        }

        public void StartInput()
        {
            billPeriodText.Focus();
        }

        public void FocusAgentInput()
        {
            agentIdText.Focus();
            agentIdText.SelectAll();
        }

        public decimal? UsedDeposit
        {
            set 
            {
                _usedDeposit = value;
                decimal? availableDeposit = Convert.ToDecimal(depositAmountText.Text) - _usedDeposit;
                availableDepositText.Text = DaHelper.ToMoneyFormat(availableDeposit);
                if (availableDeposit.Value < 0)
                    availableDepositText.ForeColor = Color.Red;
                else
                    availableDepositText.ForeColor = SystemColors.HotTrack;
            }
            get { return _usedDeposit; }
        }


        public void SetDefaultCursor()
        {
            this.Cursor = Cursors.Default;
        }

        public DeckWorkspace BookManagerDeckWorkspace
        {
            get { return BookMgrDeckWorkspace; }
        }

        public DeckWorkspace CallingBillDeckWorkSpace
        {
            get { return callingBillDeckSpace; }
        }

        public DeckWorkspace NoneCallingBillDeckWorkSpace 
        {
            get { return noneCallingBillWorkSpace; }
        }

        public DeckWorkspace SumCallingBillDeckWorkSpace 
        {
            get { return sumCallingBillDeckWorkSpace; }
        }

        public DeckWorkspace LineBillDeckWorkSpace
        {
            get { return lineBillDeckWorkSpace; }
        }

        public DeckWorkspace LineNoBillDeckWorkSpace 
        {
            get { return lineNoBillDeckWorkSpace; }
        }


        public string CancelBillBookId
        {
            get 
            {
                if (cancelBillBookIdTb.Text != String.Empty)
                {
                    return String.Format("{0}{1}",Session.Branch.Id, cancelBillBookIdTb.Text.Trim());
                }
                else
                {
                    return String.Empty;
                }
            }
        }

        /// <summary>
        /// Sets the presenter. The dependency injection system will automatically
        /// create a new presenter for you.
        /// </summary>
        [CreateNew]
        public BillBookSearchViewPresenter Presenter
        {
            set
            {
                _presenter = value;
                _presenter.View = this;
            }
        }

        private void FillDueDates()
        {
            DateTime defDate1 = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 3);
            //TimeSpan tSpan1 = new System.TimeSpan(3, 0, 0, 0);
            //DateTime defDate1 = Session.BpmDateTime.Now + tSpan1;
            string defInput1 = defDate1.ToString("dd/MM/yyyy", _th_dt);
            advancePaymentDateText.Text = defInput1;

            //default = today + 5 days
            DateTime defDate2 = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 5);
            //TimeSpan tSpan2 = new System.TimeSpan(5, 0, 0, 0);
            //DateTime defDate2 = Session.BpmDateTime.Now + tSpan2;
            string defInput2 = defDate2.ToString("dd/MM/yyyy", _th_dt);
            returnedDateText.Text = defInput2;
        }
     
        protected override void OnLoad(EventArgs e)
        {
            _presenter.OnViewReady();
            FillDueDates();          
            billPeriodText.Focus();
            billPeriodText.SelectAll();
            _presenter.ShowStatusText("Ready");
        }

        private void passBookTab_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (pastBookTab.SelectedIndex == 0) // calling bill
            {
                if (_isEditBillBook)
                    _presenter.RetreiveOldBookDetail();
                else
                {
                    //string period = StringConvert.UnFormatPeriod(billPeriodText.Text.Trim());
                    _presenter.CallingBillButtonClicked();
                }
            }
            else if (pastBookTab.SelectedIndex == 1) //none calling bill
            {
                _presenter.NoneCallingBillButtonClicked();
            }
            else if (pastBookTab.SelectedIndex == 2) //summary calling bill - NO ARGUMENT !!!
            {
                if (_isEditBillBook)
                    _presenter.RetrieveOldBookSummary();
                else
                    _presenter.SummarizeCallingBillButtonClicked();
            }
            else if (pastBookTab.SelectedIndex == 3) //line bill
            {
                if (_isEditBillBook)
                    _presenter.RetreiveOldBookLine(_focusedLine);
                else 
                    _presenter.PortionBillButtonClicked(_focusedLine);
            }
            else if (pastBookTab.SelectedIndex == 4) //line no bill
            {
                _presenter.PortionNoCallBillButtonClicked(_focusedLine);
            }
            //else if(pastBookTab.SelectedIndex == 5) // the other bill
            //   MessageBox.Show("Waiting for SAP integration !");
                //_presenter.TheOtherBillsButtonClicked();            
        }

        public void BillbookHeaderEnable(bool enable)
        {
            //agentNameText.Enabled = enable;
            //agentStatusText.Enabled = enable;
            //agentTypeText.Enabled = enable;
            //agentIdText.Enabled = enable;
            controllerIdText.Enabled = enable;
            //datetime 
            advancePaymentDateText.Enabled = enable;
            returnedDateText.Enabled = enable;
            //depositAmountText.Enabled = enable;
            firstPaidRb.Enabled = enable;
            repPaidRb.Enabled = enable;
        }

        public void ClearHeader()
        {
            billPeriodText.ResetText();
            agentIdText.ResetText();
            agentNameText.ResetText();
            agentStatusText.ResetText();
            agentTypeText.ResetText();
            receiveCountText.ResetText();
            controllerIdText.ResetText();
            availableDepositText.ResetText();
            //datetime 
            advancePaymentDateText.ResetText();
            returnedDateText.ResetText();            
            depositAmountText.ResetText();
            _bookHeader = null;
            _isEditBillBook = false;
            cancelBillBookIdTb.ResetText();
            _agentInfo = new AgentInfo();

            _bookHolderState =  BookHolderState.Agent;
            firstPaidRb.Checked = true;

            DateTime defDate1 = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 3);
            //TimeSpan tSpan1 = new System.TimeSpan(3, 0, 0, 0);
            //DateTime defDate1 = Session.BpmDateTime.Now + tSpan1;
            string defInput1 = defDate1.ToString("dd/MM/yyyy", _th_dt);
            advancePaymentDateText.Text = defInput1;

            DateTime defDate2 = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 5);
            //TimeSpan tSpan2 = new System.TimeSpan(5, 0, 0, 0);
            //DateTime defDate2 = Session.BpmDateTime.Now + tSpan2;
            string defInput2 = defDate2.ToString("dd/MM/yyyy", _th_dt);
            returnedDateText.Text = defInput2;
            _presenter.ShowStatusText("Ready");
            billPeriodText.Focus();
        }

        public BillBookHeaderInfo GetBillBookHeader()
        {            
            BillBookHeaderInfo bookHeader = new BillBookHeaderInfo();
            if (_agentInfo == null && _bookHeader == null) return bookHeader;

            try
            {
                bookHeader.IsEditBillBook = _isEditBillBook ;
                bookHeader.ControllerId = controllerIdText.Text;
                bookHeader.Period = billPeriodText.Text;
                bookHeader.AgentId = agentIdText.Text;
                bookHeader.AgentName = agentNameText.Text;
                bookHeader.AgentStatus = agentStatusText.Text;
                bookHeader.AgentType = agentTypeText.Text;                
                bookHeader.BookLot = StringConvert.ToInt32(receiveCountText.Text.Substring(0, 2));
                bookHeader.ReceiveCount = Convert.ToByte(receiveCountText.Text.Substring(3, 2));
                bookHeader.BookHolderBranchId = branchIdText.Text;
                if (_bookHeader != null && _bookHeader.BillBookId != null)
                    bookHeader.BillBookId = _bookHeader.BillBookId;
            
                //datetime convert to US format - this logic does not work
                if (_agentInfo.IsAgency)
                {
                    bookHeader.AdvancePaymentDt = DateTime.ParseExact(advancePaymentDateText.Text, "dd/MM/yyyy", _th_dt);
                }
                else
                {
                    bookHeader.AdvancePaymentDt = Convert.ToDateTime(Session.BpmDateTime.Now.Date, new CultureInfo("th-TH", true));
                }
             
                bookHeader.ReturnedBillDt = DateTime.ParseExact(returnedDateText.Text, "dd/MM/yyyy", _th_dt);

                if (depositAmountText.Text != "")
                    bookHeader.TotalAsset = Convert.ToDecimal(depositAmountText.Text);

                if (firstPaidRb.Checked)
                    bookHeader.IsFirstPaid = true;
                else if (repPaidRb.Checked)
                    bookHeader.IsFirstPaid = false;
 
                bookHeader.IsPrintPreview = printPreviewCb.Checked;
                bookHeader.IsPrintDetail = printDetailCb.Checked;
                bookHeader.IsAgency = _agentInfo.IsAgency;
            }
            catch (Exception e)
            {
                MessageBox.Show(null, "ป้อนข้อมูลส่วนหัวของสมุดจ่ายบิลไม่ถูกต้องหรือป้อนไม่ครบ", "ข้อมูลไม่สมบูรณ์", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            return bookHeader;
        }

        private void FillAgentInfomation(AgentInfo agentInfo)
        {
            if (agentInfo == null || agentInfo.Id == null)
            {
                agentNameText.ResetText();
                agentTypeText.ResetText();
                agentStatusText.ResetText();
                depositAmountText.ResetText();
                receiveCountText.ResetText();
                availableDepositText.ResetText();
                receiveCountText.Enabled = false;
                advancePaymentDateText.Enabled = false;
                returnedDateText.Enabled = false;
                controllerIdText.Enabled = false;                
                return;
            }

            receiveCountText.Enabled = true;
            controllerIdText.Enabled = true;

            if (agentInfo.BookHolder == (int)BookHolderState.Agent)
            {
                advancePaymentDateText.Enabled = true;
                returnedDateText.Enabled = true;
            }
            else
            {
                advancePaymentDateText.Enabled = false;
                returnedDateText.Enabled = false;
            }

            agentNameText.Text = agentInfo.Name;
            agentTypeText.Text = agentInfo.Type;
            agentStatusText.Text = agentInfo.AgencyStatus;
            branchIdText.Text = agentInfo.TechBranchId;
            depositAmountText.Text = agentInfo.Deposit == null ? "0.00" : agentInfo.Deposit.Value.ToString("#,##0.00");
            receiveCountText.Focus();

            //decreate time from calling webservice
            UsedDeposit = agentInfo.UseDeposit;
            //_presenter.GetAvailableDeposit(agentIdText.Text);
           
        }

        private void billPeriodText_Leave(object sender, EventArgs e)
        {
            if (!(billPeriodText.Text.Replace("/", "").Trim() == ""))
            {
                if (!TextUtility.IsValidPeriod(billPeriodText.Text))
                {
                    DialogResult dlg = MessageBox.Show(null, "ค่ารอบเดือนไม่ถูกต้อง กรุณากดปุ่ม Ok เพื่อกำหนดเป็นเดือนปัจจุบัน \nกด Cancel เพื่อป้อนค่าใหม่ ", "ป้อนค่าผิด", MessageBoxButtons.OKCancel, MessageBoxIcon.Warning);
                    if (dlg == DialogResult.OK)
                    {
                        //DateTime defDate = Session.BpmDateTime.Now;
                        //string defInput = defDate.ToString("MM/yyyy", _th_dt);
                        string dt = "";
                        if (_th_dt.NativeCalendarName != "พุทธศักราช")
                            dt = Session.BpmDateTime.Now.AddYears(543).ToString("MM/yyyy", _th_dt);
                        else
                            dt = Session.BpmDateTime.Now.ToString("MM/yyyy", _th_dt);
                        billPeriodText.Text = dt;//defInput;
                    }
                    else
                    {
                        _presenter.SaveEnable(false);
                        billPeriodText.Focus();
                        billPeriodText.SelectAll();
                    }
                }
                else
                {
                    if (!TextUtility.IsInPeriod(billPeriodText.Text,2))
                        _presenter.SaveEnable(false);
                    else
                        _presenter.SaveEnable(true);
                }
            }
        }
        

        private void billPeriodText_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                _presenter.SaveEnable(true);
                agentIdText.SelectAll();
                agentIdText.Focus();
                ////verify input here 
                //if (!TextUtility.IsValidPeriod(billPeriodText.Text))
                //{
                //    DialogResult dlg = MessageBox.Show(null, "ค่ารอบเดือนไม่ถูกต้อง กรุณากดปุ่ม Ok เพื่อกำหนดเป็นเดือนปัจจุบัน \nกด Cancel เพื่อป้อนค่าใหม่ ", "ป้อนค่าผิด", MessageBoxButtons.OKCancel, MessageBoxIcon.Warning);
                //    if (dlg == DialogResult.OK)
                //    {
                //        DateTime defDate = Session.BpmDateTime.Now;
                //        string defInput = defDate.ToString("MM/yyyy", _th_dt);
                //        billPeriodText.Text = defInput;
                //        agentIdText.Focus();
                //        agentIdText.SelectAll();
                //    }
                //    else
                //    {
                //        billPeriodText.SelectAll();
                //    }
                //}
                //else
                //{
                //    //if (!TextUtility.IsCurrentPeriod(billPeriodText.Text))
                //    //{
                //    //    _presenter.SaveEnable(false);                      
                //    //}
                //    if (!TextUtility.IsInPeriod(billPeriodText.Text.Trim(),2))
                //    {
                //        _presenter.SaveEnable(false);
                //    }
                //    else
                //        _presenter.SaveEnable(true);
                //    if (_agentInfo != null)
                //    {
                //        if (_agentInfo.ReceiveCount != 0 && !TextUtility.IsInPeriod(billPeriodText.Text,2))
                //        {
                //            FocusBillManInput();
                //        }
                //        else 
                //        {
                //            agentIdText.Focus();
                //            agentIdText.SelectAll();
                //        }
                //    }
                //    else
                //    {
                //        agentIdText.Focus();
                //        agentIdText.SelectAll();
                //    }                  
                //}
            }
            else if (e.KeyCode == Keys.N)
            {
                //set default for this month
                //DateTime defDate = Session.BpmDateTime.Now;
                //string defInput = defDate.ToString("MM/yyyy", _th_dt);
                string dt = "";
                if (_th_dt.NativeCalendarName != "พุทธศักราช")
                    dt = Session.BpmDateTime.Now.AddYears(543).ToString("MM/yyyy", _th_dt);
                else
                    dt = Session.BpmDateTime.Now.ToString("MM/yyyy", _th_dt);
                billPeriodText.Text = dt;
                agentIdText.Focus();
                agentIdText.SelectAll();
            }
        }

        private void advancePaymentDateText_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                returnedDateText.Focus();
                returnedDateText.SelectAll();
            }
            else if (e.KeyCode == Keys.N || e.KeyCode == Keys.Escape)
            {
                //default = today + 3days
                DateTime defDate = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 3);
                //TimeSpan tSpan = new System.TimeSpan(3, 0, 0, 0);
                //DateTime defDate = Session.BpmDateTime.Now + tSpan;
                string defInput = defDate.ToString("dd/MM/yyyy", _th_dt);

                advancePaymentDateText.Text = defInput;
                returnedDateText.Focus();
                returnedDateText.SelectAll();
            }
            
        }

        private void returnedDateText_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                mainBookManagementTab.SelectTab(0);
                _presenter.JumpToStartCallingBillCursorActivated();
            }
            else if (e.KeyCode == Keys.N || e.KeyCode == Keys.Escape)
            {
                //default = today + 5 days
                DateTime defDate = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 5);
                //TimeSpan tSpan = new System.TimeSpan(5, 0, 0, 0);
                //DateTime defDate = Session.BpmDateTime.Now + tSpan;
                string defInput = defDate.ToString("dd/MM/yyyy", _th_dt);
                returnedDateText.Text = defInput;
            }
        }

        public void ActivateBookCreationPanel()
        {
            mainBookManagementTab.SelectTab(0);
            //begin edit at the last row, first column
            _presenter.StartNextInput();
        }

        public void ActivateFindResultPanel(int index)
        {
            //open up find panel
            mainBookManagementTab.SelectTab(1);
            //calling bill summarizing            
            pastBookTab.SelectTab(index);
            //_presenter.SummarizeCallingBillButtonClicked();
           
        }

        private void agentIdText_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {              
                //verify input here
              /*  if (agentIdText.Text.Length != ModuleConfigurationNames.AgentIdLength && agentIdText.Text.Length != ModuleConfigurationNames.EmployeeLength)
                {
                    MessageBox.Show(null, "ป้อนค่าข้อมูลไม่ถูกต้อง", "คำเตือน", MessageBoxButtons.OKCancel, MessageBoxIcon.Warning);
                    agentIdText.SelectAll();                  
                    return;
                }
               * */
                if (billPeriodText.Text.Replace("/", "").Trim() == "")
                {
                    billPeriodText.Focus();
                    billPeriodText.SelectAll();
                }

                //find employee or agent or employee               
                _presenter.BillBookAgentIdSearchTextCommitted(agentIdText.Text);
                if (_agentInfo != null && _agentInfo.Id != null)
                {
                    if (_agentInfo.Id.Trim().Length == 12)
                    {
                        agentIdText.Text = _agentInfo.Id.Trim().Substring(4);
                    }
                    else
                    {
                        agentIdText.Text = _agentInfo.Id.Trim().PadLeft(8, '0');
                    }

                    if (!_agentInfo.IsAgency)
                    {
                        advancePaymentDateText.ResetText();
                        advancePaymentDateText.Enabled = false;
                        DateTime? retDt = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 1);
                        returnedDateText.Text = retDt.Value.ToString("dd/MM/yyyy", new CultureInfo("th-TH", true));
                    }
                    else
                    {
                        advancePaymentDateText.Enabled = true;
                    }
                }
            }
            else if (e.KeyCode == Keys.F1)
            {
                ArrayList parem = new ArrayList();
                parem.Add("รหัสตัวแทน");
                parem.Add("ประกอบด้วยตัวเลข 6 หลัก");
                parem.Add("โดยสามารถเป็นได้ทั้งรหัสตัวแทนเก็บเงิน");
                parem.Add("หรือรหัสพนักงานการไฟฟ้า(ออกเก็บแทน)");
                parem.Add("ตัวอย่าง \"900011\"");
                _presenter.ShowHint(parem);
            }
        }

        public void RenewOldBook()
        {
            if (agentIdText.Text.Trim() == "") return;

            ActivateBookCreationPanel();
            //book period
            billPeriodText.Text = Session.BpmDateTime.Now.ToString("MM/yyyy", _th_dt);
            _presenter.BillBookAgentIdSearchTextCommitted(agentIdText.Text);
            _presenter.GetAvailableDeposit(agentIdText.Text);
            List<string> searchConn = new List<string>();
            searchConn.Add(agentIdText.Text.Trim());
            searchConn.Add(controllerIdText.Text.Trim());
            _presenter.BillBookLoadValidationDataActived(searchConn);           
            FillDueDates();
            _presenter.SaveEnable(true);
        }

        //private void receiveCountText_KeyDown(object sender, KeyEventArgs e)
        //{
        //    // TODO : If user need this function fix it : กด F5,F4 ได้ข้อมูลเหมือนกัน

        //    //if (e.KeyCode == Keys.Enter)
        //    //{
        //    //    //verify input here - we have text mask so no worry about input digits
        //    //    int input = Convert.ToInt32(receiveCountText.Text);
        //    //    if (_receiveCount != null && input > _receiveCount)
        //    //    {
        //    //        DialogResult dlg = MessageBox.Show(null, "ไม่อนุญาติให้กำหนดเกินค่า: " + _receiveCount.Value.ToString().PadLeft(2, '0') + " \nกดปุ่ม Ok เพื่อทำรายการต่อหรือกดปุ่ม Cancel เพื่อแก้ไขข้อมูล \n", "ป้อนค่าผิด", MessageBoxButtons.OKCancel, MessageBoxIcon.Warning);
        //    //        if (dlg == DialogResult.OK)
        //    //        {
        //    //            receiveCountText.Text = _receiveCount.Value.ToString().PadLeft(2, '0');
        //    //            billManIdText.Focus();
        //    //            billManIdText.SelectAll();
        //    //        }
        //    //        else
        //    //        {
        //    //            receiveCountText.SelectAll();
        //    //        }
        //    //    }
        //    //    else if (input == 0)
        //    //    {
        //    //        DialogResult dlg = MessageBox.Show(null, "ไม่อนุญาติให้กำหนดค่านี้ \nกดปุ่ม Ok เพื่อทำรายการต่อหรือกดปุ่ม Cancel เพื่อแก้ไขข้อมูล \n", "ป้อนค่าผิด", MessageBoxButtons.OKCancel, MessageBoxIcon.Warning);
        //    //        if (dlg == DialogResult.OK)
        //    //        {
        //    //            receiveCountText.Text = _receiveCount.Value.ToString().PadLeft(2, '0');
        //    //            billManIdText.Focus();
        //    //            billManIdText.SelectAll();
        //    //        }
        //    //        else
        //    //        {
        //    //            receiveCountText.SelectAll();
        //    //        }
        //    //    }
        //    //    else 
        //    //    {
        //    //        //check for existing receiveCount
        //    //        BillBookItemListInputInfo inputInfo = new BillBookItemListInputInfo();
        //    //        inputInfo.HeaderInfo.AgentId = agentIdText.Text;
        //    //        inputInfo.HeaderInfo.Period = billPeriodText.Text;
        //    //        inputInfo.HeaderInfo.ReceiveCount = Convert.ToByte(receiveCountText.Text);
        //    //        _presenter.CheckForExistingReceiveCount(inputInfo);
        //    //        //billManIdText.Focus();
        //    //        //billManIdText.SelectAll();
        //    //    }
        //    //}
        //}

        private void billManIdText_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (controllerIdText.Text == "" || controllerIdText.Text.Trim().Length > ModuleConfigurationNames.EmployeeLength)
                {
                    MessageBox.Show(null, "กรุณาป้อนรหัสพนักงานควบคุมใบเสร็จ", "ข้อมูลไม่ถูกต้อง", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    controllerIdText.Focus();
                    return;
                }
                else
                {
                    string employeeNo = controllerIdText.Text.Trim().PadLeft(ModuleConfigurationNames.EmployeeLength, '0');
                    controllerIdText.Text = employeeNo; 
                    _presenter.CheckEmployeeNo(employeeNo);                                     
                }              
            }         
        }

        private void cancelBillBookIdTb_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (cancelBillBookIdTb.Text.Length == ModuleConfigurationNames.BillBookLengthOnly + 1)
                {                   
                     //_presenter.PastBillBookQueryActivated(string.Format("{0}{1}", Session.Branch.Id, pastBillBookId.Text.Replace("-","")));   
                    _presenter.CheckAndLoadExistingBillBook(string.Format("{0}{1}", Session.Branch.Id, cancelBillBookIdTb.Text.Replace("-", "")));
                }
            }
        }

        public void FillPastBillBookHeader(BillBookItemListInputInfo bookItemList, bool freeze)
        {
            if (bookItemList == null)
            {
                return;
            }

            _bookHeader = bookItemList.HeaderInfo;
            billPeriodText.Text = _bookHeader.Period;
            agentIdText.Text = _bookHeader.AgentId.PadLeft(8, '0');
            agentNameText.Text = _bookHeader.AgentName;
            agentStatusText.Text = _bookHeader.AgentStatus;
            agentTypeText.Text = _bookHeader.AgentType;
            receiveCountText.Text = String.Format("{0}/{1}", _bookHeader.BookLot.ToString().PadLeft(2, '0'), _bookHeader.ReceiveCount.ToString().PadLeft(2, '0'));
            controllerIdText.Text = _bookHeader.ControllerId;
            advancePaymentDateText.Text = _bookHeader.AdvancePaymentDt.Value.ToString("dd/MM/yyyy", _th_dt);
            returnedDateText.Text = _bookHeader.ReturnedBillDt.Value.ToString("dd/MM/yyyy", _th_dt);
            depositAmountText.Text = DaHelper.ToMoneyFormat(_bookHeader.TotalAsset);
            availableDepositText.Text = "N/A";
            receiveCountText.Enabled = true;
            _isEditBillBook = bookItemList.IsEditBillBook;           
           
            _presenter.SaveEnable(bookItemList.IsEditBillBook);
           
            
            //if (freeze)
            //    _presenter.SaveEnable(false);
            //else
            //    _presenter.SaveEnable(true);

            if (_bookHeader.IsAgency)
                _bookHolderState = BookHolderState.Agent;
            else
                _bookHolderState = BookHolderState.Employee;           

        }

        private void cancelBillBookIdTb_Enter(object sender, EventArgs e)
        {
            //figure out why to focus the box again
            cancelBillBookIdTb.Focus();
            cancelBillBookIdTb.SelectAll();            
        }

        private void BillBookSearchView_KeyDown(object sender, KeyEventArgs e)
        {   
            //put short cut key - Fix me!
            if(e.KeyCode == Keys.X)
            {
                cancelBillBookIdTb.Focus();
                cancelBillBookIdTb.SelectAll();
            }
        }

        private void firstPaidRb_KeyDown(object sender, KeyEventArgs e)
        {
            if (firstPaidRb.Checked && e.KeyCode == Keys.Right)
            {
                repPaidRb.Checked = true;
                repPaidRb.Focus();
            }
            else if (e.KeyCode == Keys.Enter)
            {
                advancePaymentDateText.Focus();
            }
            else if (e.KeyCode == Keys.N)
            {
                firstPaidRb.Checked = true;
                advancePaymentDateText.Focus();
            }
        }

        private void repPaidRb_KeyDown(object sender, KeyEventArgs e)
        {
            if (repPaidRb.Checked && e.KeyCode == Keys.Left)
            {
                firstPaidRb.Checked = true;
                firstPaidRb.Focus();
            }
            else if (e.KeyCode == Keys.Enter)
            {
                advancePaymentDateText.Focus();
            }
            else if (e.KeyCode == Keys.N)
            {
                firstPaidRb.Checked = true;
                advancePaymentDateText.Focus();
            }
        }

        //when switching from input page to searchpage, index changed event will not be activated
        private void mainBookManagementTab_KeyDown(object sender, KeyEventArgs e)
        {
            _keydownEvent = true;
            if (e.KeyCode == Keys.F3 || e.KeyCode == Keys.F4 || e.KeyCode == Keys.F5 || e.KeyCode == Keys.F6 ||
                e.KeyCode == Keys.F7 || e.KeyCode == Keys.F8)
            {             
                if (e.KeyCode == Keys.F4) // calling bill
                {
                    if (_isEditBillBook)
                        _presenter.RetreiveOldBookDetail();
                    else
                    {
                        //string period = StringConvert.UnFormatPeriod(billPeriodText.Text.Trim());
                        _presenter.CallingBillButtonClicked();                        
                    }                    
                }
                else if (e.KeyCode == Keys.F5) //none calling bill               
                {
                    _presenter.NoneCallingBillButtonClicked();
                }
                else if (e.KeyCode == Keys.F6) //summary calling bill - NO ARGUMENT !!!
                {
                    if (_isEditBillBook)
                        _presenter.RetrieveOldBookSummary();
                    else
                        _presenter.SummarizeCallingBillButtonClicked();
                }
                else if (e.KeyCode == Keys.F7) //line bill
                {
                    if (_isEditBillBook)
                        _presenter.RetreiveOldBookLine(_focusedLine);
                    else
                        _presenter.PortionBillButtonClicked(_focusedLine);
                }
                else if (e.KeyCode == Keys.F8) //line no bill
                {
                    _presenter.PortionNoCallBillButtonClicked(_focusedLine);
                }

                _presenter.ShowStatusText("Ready");
                return;
            }

            if (e.KeyCode == Keys.F3) //always reload when get back to main page
                ActivateBookCreationPanel();
            else if (e.KeyCode == Keys.F12)
                _presenter.BillBookSaveRequestClicked();

            if(e.KeyCode != Keys.F3)
                _presenter.ShowStatusText("Ready");

            _keydownEvent = false;
        }

        //private void advancePaymentDateText_Leave(object sender, EventArgs e)
        //{
        //    CheckAdvPaymentDt();
        //}

        public bool CheckReturnDt()
        {
            bool retVal = true;
            //verify input
            try
            {
                if (_agentInfo.IsAgency)
                {
                    DateTime advDt = DateTime.ParseExact(advancePaymentDateText.Text, "dd/MM/yyyy", _th_dt);
                    DateTime retDt = DateTime.ParseExact(returnedDateText.Text, "dd/MM/yyyy", _th_dt);
                    if (retDt < Session.BpmDateTime.Now)
                    {
                        MessageBox.Show(null, "วันนำส่งคืนสมุดไม่สามารถกำหนดย้อนหลังได้", "ป้อนวันที่ไม่ถูกต้อง", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        returnedDateText.Focus();
                        returnedDateText.SelectAll();
                        retVal = false;
                    }
                    else if (retDt > _calendar.NextBusinessDay(Session.BpmDateTime.Now, 30))
                    {
                        MessageBox.Show(null, "กำหนดวันนำส่งคืนสมุดเกินขอบเขต", "เกินขอบเขต", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        returnedDateText.Focus();
                        returnedDateText.SelectAll();
                        retVal = false;
                    }
                    else if (advDt > retDt)
                    {
                        MessageBox.Show(null, "ไม่สามารถกำหนดวันนำส่งคืนสมุดเกินวันคืนสมุด", "เกินขอบเขต", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        returnedDateText.Focus();
                        returnedDateText.SelectAll();
                        retVal = false;
                    }
                    else if (_calendar.IsNonWorkingDay(retDt))
                    {
                        DialogResult dlg = MessageBox.Show(null, "วันที่กำหนดเป็นวันหยุด \nต้องการกำหนดอัตโนมัติ กรุณากดปุ่ม Yes", "วันหยุด", MessageBoxButtons.YesNo, MessageBoxIcon.Error);
                        if (dlg == DialogResult.Yes)
                        {
                            DateTime defDate = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 5);
                            returnedDateText.Text = defDate.ToString("dd/MM/yyyy", _th_dt);
                        }
                        else
                        {
                            returnedDateText.Focus();
                            returnedDateText.SelectAll();
                        }
                        retVal = false;
                    }
                }
                else
                {
                    DateTime retDt = DateTime.ParseExact(returnedDateText.Text, "dd/MM/yyyy", _th_dt);
                    DateTime expireDt = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 1);                    
                    if (retDt.CompareTo(expireDt) > 0)
                    {
                        MessageBox.Show(null, "กำหนดวันนำส่งคืนสมุดเกินขอบเขต", "เกินขอบเขต", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        returnedDateText.Focus();
                        returnedDateText.SelectAll();
                        retVal = false;
                    }
                    else if (_calendar.IsNonWorkingDay(retDt))
                    {
                        DialogResult dlg = MessageBox.Show(null, "วันที่กำหนดเป็นวันหยุด \nต้องการกำหนดอัตโนมัติ กรุณากดปุ่ม Yes", "วันหยุด", MessageBoxButtons.YesNo, MessageBoxIcon.Warning);
                        if (dlg == DialogResult.Yes)
                        {
                            DateTime defDate = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 1);
                            returnedDateText.Text = defDate.ToString("dd/MM/yyyy", _th_dt);
                        }
                        else
                        {
                            returnedDateText.Focus();
                            returnedDateText.SelectAll();
                        }
                        retVal = false;
                    }
                }
            }
            catch (Exception)
            {
                MessageBox.Show(null, "ป้อนค่าวันนำส่งเงิน 30% ไม่ถูกต้อง 'dd/mm/yyyy'", "ป้อนค่าวันที่ไม่ถูกต้อง", MessageBoxButtons.OK, MessageBoxIcon.Error);
                retVal = false;
            }
            return retVal;
        }

        public bool CheckAdvPaymentDt()
        {
            bool retVal = true;
            //verify input
            try
            {

                if (_agentInfo.IsAgency)
                {
                    DateTime advDt = DateTime.ParseExact(advancePaymentDateText.Text, "dd/MM/yyyy", _th_dt);
                    DateTime retDt = DateTime.ParseExact(returnedDateText.Text, "dd/MM/yyyy", _th_dt);
                    if (advDt < Session.BpmDateTime.Now)
                    {
                        MessageBox.Show(null, "วันนำส่ง 30% ไม่สามารถกำหนดย้อนหลังได้", "ป้อนวันที่ไม่ถูกต้อง", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        advancePaymentDateText.Focus();
                        advancePaymentDateText.SelectAll();
                        retVal = false;
                    }
                    else if (advDt > _calendar.NextBusinessDay(Session.BpmDateTime.Now, 30))
                    {
                        MessageBox.Show(null, "กำหนดวันนำส่ง 30% เกินขอบเขต", "เกินขอบเขต", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        advancePaymentDateText.Focus();
                        advancePaymentDateText.SelectAll();
                        retVal = false;
                    }
                    else if (advDt > retDt)
                    {
                        MessageBox.Show(null, "ไม่สามารถกำหนดวันนำส่ง 30% เกินวันคืนสมุด", "เกินขอบเขต", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        advancePaymentDateText.Focus();
                        advancePaymentDateText.SelectAll();
                        retVal = false;
                    }
                    else if (_calendar.IsNonWorkingDay(advDt))
                    {
                        DialogResult dlg = MessageBox.Show(null, "วันที่กำหนดเป็นวันหยุด \nต้องการกำหนดอัตโนมัติ กรุณากดปุ่ม Yes", "วันหยุด", MessageBoxButtons.YesNo, MessageBoxIcon.Warning);
                        if (dlg == DialogResult.Yes)
                        {
                            DateTime defDate = _calendar.NextBusinessDay(Session.BpmDateTime.Now, 3);
                            advancePaymentDateText.Text = defDate.ToString("dd/MM/yyyy", _th_dt);
                        }
                        else
                        {
                            advancePaymentDateText.Focus();
                            advancePaymentDateText.SelectAll();
                        }
                        retVal = false;
                    }
                }
            }
            catch (Exception)
            {
                MessageBox.Show(null, "ป้อนค่าวันนำส่งเงิน 30% ไม่ถูกต้อง 'dd/mm/yyyy'", "ป้อนค่าวันที่ไม่ถูกต้อง", MessageBoxButtons.OK, MessageBoxIcon.Error);
                retVal = false;
            }
            return retVal;
        }

        public void FocusBillManInput()
        {
            controllerIdText.Clear();
            controllerIdText.Focus();
        }

        public void FoundEmployeeNo()
        {
            mainBookManagementTab.SelectTab(0);
            _presenter.JumpToStartCallingBillCursorActivated();
            
            //load validate lines assigned to this agent
            List<string> searchConn = new List<string>();
            searchConn.Add(_agentInfo.Id);
            searchConn.Add(controllerIdText.Text.Trim());
            _presenter.BillBookLoadValidationDataActived(searchConn);
            _presenter.SaveEnable(true);

            this.Cursor = Cursors.Default;
        }

        private void pastBookTab_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.F3)
                ActivateBookCreationPanel();
        }

        private void advancePaymentDateText_Enter(object sender, EventArgs e)
        {
            string agency = null;
            if (_agentInfo != null)
                agency = string.Format("{0}-{1}", _agentInfo.Id, _agentInfo.Name);

            if (!Authorization.IsAuthorized(SecurityNames.EditBillBookDueDate, "แก้ไขวันนำส่ง 30% ของตัวแทน : " + agency, false))
            {
                billPeriodText.Focus();
                billPeriodText.SelectAll();
            }
            else
            {
                advancePaymentDateText.SelectAll();
            }
        }

        private void returnedDateText_Enter(object sender, EventArgs e)
        {
            string agency = null;
            if (_agentInfo != null)
                agency = string.Format("{0}-{1}", _agentInfo.Id, _agentInfo.Name);

            if (!Authorization.IsAuthorized(SecurityNames.EditBillBookDueDate, "แก้ไขวันคืนสมุดของตัวแทน : " + agency, false))
            {
                billPeriodText.Focus();
                billPeriodText.SelectAll();
            }
            else
            {
                returnedDateText.SelectAll();
            }
        }

        private void mainBookManagementTab_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_billBookMgtView.BookInputList.CreationItemList.Count == 0)
            {
                mainBookManagementTab.SelectTab(0);
                _presenter.JumpToStartCallingBillCursorActivated();
                return;
            }

            if (mainBookManagementTab.SelectedIndex == 1 && !_keydownEvent)
            {
                _presenter.SummarizeCallingBillButtonClicked();
                ActivateFindResultPanel(2); //summary

            }
        }

        #region HINT

        private void agentSearchAssignImgHint_Click(object sender, EventArgs e)
        {
            ArrayList parem = new ArrayList();
            parem.Add("รหัสตัวแทน");
            parem.Add("กำหนดเลขที่ผู้รับสมุดจ่ายบิล");
            parem.Add("6 หลักสำหรับบุคคลหรือนิติบุคคลที่เป็นผู้รับสมุดจ่ายบิล");            
            parem.Add("8 หลักสำหรับพนักงานการไฟฟ้าที่เป็นผู้รับสมุดจ่ายบิล");
            parem.Add("ตัวอย่าง \"105387\"");
            _presenter.ShowHint(parem);
        }               

        private void billCtrlImgHint_Click(object sender, EventArgs e)
        {
            ArrayList parem = new ArrayList();
            parem.Add("รหัส พบช.");
            parem.Add("รหัสพนักงานควบคุมใบเสร็จ");
            parem.Add("เป็นพนักงานที่ดูแลผู้ใช้ไฟฟ้าแต่ละราย ");
            parem.Add("เป็นตัวเลข 6 หลักสำหรับแต่ละ กฟฟ.");            
            parem.Add("ตัวอย่าง \"00999111\"");
            _presenter.ShowHint(parem);
        }
       
        private void cancelBookImgHint_Click(object sender, EventArgs e)
        {
            ArrayList parem = new ArrayList();
            parem.Add("ยกเลิกสมุด");
            parem.Add("เลขที่สมุดจ่ายบิล 9 หลัก");
            parem.Add("เพื่อทำการยกเลิกสมุดจ่ายบิลที่ออกไปแล้ว");
            parem.Add("และจะต้องมีสถานะที่ยังไม่ถูกตัดชำระ");
            parem.Add("ตัวอย่าง \"500000001\"");
            _presenter.ShowHint(parem);
        }
    
        #endregion


    }
}

