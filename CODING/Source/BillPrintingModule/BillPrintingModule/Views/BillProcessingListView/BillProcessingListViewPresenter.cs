//----------------------------------------------------------------------------------------
// patterns & practices - Smart Client Software Factory - Guidance Package
//
// This file was generated by the "Add View" recipe.
//
// A presenter calls methods of a view to update the information that the view displays. 
// The view exposes its methods through an interface definition, and the presenter contains
// a reference to the view interface. This allows you to test the presenter with different 
// implementations of a view (for example, a mock view).
//
// For more information see:
// ms-help://MS.VSCC.v80/MS.VSIPCC.v80/ms.scsf.2006jun/SCSF/html/03-030-Model%20View%20Presenter%20%20MVP%20.htm
//
// Latest version of this Guidance Package: http://go.microsoft.com/fwlink/?LinkId=62182
//----------------------------------------------------------------------------------------

using System;
using Microsoft.Practices.ObjectBuilder;
using Microsoft.Practices.CompositeUI;
using Microsoft.Practices.CompositeUI.EventBroker;
using PEA.BPM.Architecture.ArchitectureTool.ErrorHandling;
using PEA.BPM.Infrastructure.Interface;
using PEA.BPM.BillPrintingModule.Constants;
using PEA.BPM.BillPrintingModule;
using PEA.BPM.BillPrintingModule.Interface.BusinessEntities;
using PEA.BPM.BillPrintingModule.Services;
using System.Collections.Generic;
using PEA.BPM.BillPrintingModule.Interface.Services;
using System.IO;
using System.Threading;
using System.Windows.Forms;
using PEA.BPM.BillPrintingModule.BillPrintingUtilities;
using PEA.BPM.Architecture.CommonUtilities;


namespace PEA.BPM.BillPrintingModule
{
    public class BillProcessingListViewPresenter : Presenter<IBillProcessingListView>
    {
        private IBillPrintingServices _printingServices;

        [InjectionConstructor]
        public BillProcessingListViewPresenter([ServiceDependency] IBillPrintingServices printingServices)
        {
            _printingServices = printingServices;
        }

        /// <summary>
        /// View Cursor Setting 
        /// </summary>
        [EventPublication(EventTopicNames.WaitCursor, PublicationScope.Global)]
        public event EventHandler<EventArgs<bool>> WaitCursorCommandHandler;
        public void OnWaitCursor(bool set)
        {
            View.OnWaitCursor(set); //this view
            if (WaitCursorCommandHandler != null)
                WaitCursorCommandHandler(this, new EventArgs<bool>(set));
        }

        /// <summary>
        /// Change Status of Left view to ready for printing the selected bill
        /// </summary>
        [EventPublication(EventTopicNames.ChangeStatusForLeftView, PublicationScope.Global)]
        public event EventHandler<EventArgs<bool>> ChangeStatus;
        public void ChangeStatusPrintingSelectedBill(bool set)
        {
            if (ChangeStatus != null)
                ChangeStatus(this, new EventArgs<bool>(set));
        }

        /// <summary>
        /// Subscribe event from a4/dualbill presenter (when user press "Print" button in "Ready to print" mode
        /// </summary>
        [EventSubscription(EventTopicNames.PrintSelectedBill, Thread = ThreadOption.UserInterface)]
        public void PrintSelectedBillInDataGridHandler(object sender, EventArgs e)
        {
            View.PrintSelectedBill();
        }

        /// <summary>
        /// Subscribe event from a4/dualbill presenter (when user press "Cancel" button in "Ready to print" mode
        /// </summary>
        [EventSubscription(EventTopicNames.ClearBillProcessingListView, Thread = ThreadOption.UserInterface)]
        public void ClearBillProcessingListViewSubscribed(object sender, EventArgs e)
        {
            View.ClearList();
            View.SummarizeRecords();
        }

        /// <summary>
        /// Change Status of Left view to ready for printing the selected bill
        /// </summary>
        [EventPublication(EventTopicNames.GrpInvAvailableBillCount, PublicationScope.Global)]
        public event EventHandler<EventArgs<int>> GrpInvAvailableBillCountHandler;
        public void ShowBillCount(int billCount)
        {
            if (GrpInvAvailableBillCountHandler != null)
                GrpInvAvailableBillCountHandler(this, new EventArgs<int>(billCount));
        }

        /// <summary>
        /// Subscribe from A4BillPresenter
        /// </summary>
        [EventSubscription(EventTopicNames.PrintA4Bill, Thread = ThreadOption.UserInterface)]
        public void PrintPrintA4BillHandler(object sender, EventArgs<BillPrintingConditionParam> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);
                View.ApproverId = e.Data.ApproverId;
                View.ApproverName = e.Data.ApproverName;
                View.ApproverPosition = e.Data.ApproverPosition;
                View.TmpBillPeriod = e.Data.BillPeriod;
                View.TmpBillType = e.Data.BillType;
                View.PrintCondition = e.Data.BillPrintingCondition;
                View.A4Reprint = e.Data.A4Reprint;
                View.PrintId = _printingServices.CheckExistRecord(e.Data);
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
            }
        }

        /// <summary>
        /// Subscribe from DualBillPresenter
        /// </summary>
        [EventSubscription(EventTopicNames.PrintDualBill, Thread = ThreadOption.UserInterface)]
        public void PrintDualBillHandler(object sender, EventArgs<BillPrintingConditionParam> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);

                View.TmpBillPeriod = e.Data.BillPeriod;
                View.TmpBillType = e.Data.BillType;
                View.PrintCondition = e.Data.BillPrintingCondition;
                View.HasOrgDoc = e.Data.HasOrgDoc;
                View.PrintId = _printingServices.CheckExistRecord(e.Data);
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }

        }

        /// <summary>
        /// Subscribe from DualBillReprintPresenter
        /// </summary>
        [EventSubscription(EventTopicNames.ReprintDualBill, Thread = ThreadOption.UserInterface)]
        public void ReprintDualBillHandler(object sender, EventArgs<BillPrintingConditionParam> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);
                View.HasOrgDoc = e.Data.HasOrgDoc;
                View.TmpBillPeriod = e.Data.BillPeriod;
                View.TmpBillType = e.Data.BillType;
                View.IsReprintBill = e.Data.IsReprintBill;
                View.PrintCondition = e.Data.BillPrintingCondition;
                View.PrintId = _printingServices.CheckExistReprintRecord(e.Data);
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }
        }

        /// <summary>
        /// Subscribe from GroupInvoicePresenter
        /// </summary>
        [EventSubscription(EventTopicNames.PrintGroupInvoice, Thread = ThreadOption.UserInterface)]
        public void PrintGroupInvoiceHandler(object sender, EventArgs<GroupInvoiceParam> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);
                View.ApproverId = e.Data.ApproverId;
                View.ApproverName = e.Data.ApproverName;
                View.ApproverPosition = e.Data.ApproverPosition;
                View.TmpBillPeriod = e.Data.PaymentDueDate;
                View.PrintCondition = e.Data.PrintingCondition;

                List<PrintableId> _chkResult = _printingServices.CheckExistGroupInvoiceRecord(e.Data);

                int billCount = 0;
                foreach (PrintableId pt in _chkResult)
                {
                    if (pt.BillCount != null)
                        billCount += pt.BillCount.Value;
                }

                ShowBillCount(billCount);

                //modified code
                View.TmpBillType = (int)BillType.GroupInvoiceA4Bill;
                View.PrintId = _chkResult;
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }
        }

        /// <summary>
        /// Subscribe from GroupInvoiceReprintPresenter
        /// </summary>
        [EventSubscription(EventTopicNames.ReprintGroupInvoice, Thread = ThreadOption.UserInterface)]
        public void ReprintGroupInvoiceHandler2(object sender, EventArgs<GroupInvoiceParam> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);
                View.TmpBillPeriod = e.Data.PaymentDueDate;
                View.ApproverId = e.Data.ApproverId;
                View.ApproverName = e.Data.ApproverName;
                View.ApproverPosition = e.Data.ApproverPosition;
                View.TmpBillType = e.Data.BillType;
                View.PrintCondition = e.Data.PrintingCondition;
                View.IsReprintBill = true;

                List<PrintableId> _chkResult = _printingServices.CheckExistReprintGroupInvoiceRecord(e.Data);

                View.TmpBillType = (int)BillType.ReprintGroupInvoiceA4Bill;
                View.PrintId = _chkResult;
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }
        }

        /// <summary>
        /// Subscribe from DirectDebitPresenter
        /// This greenBill is not the same with green in dualbill!
        /// </summary>
        [EventSubscription(EventTopicNames.PrintGreenBill, Thread = ThreadOption.UserInterface)]
        public void PrintGreenBillHandler(object sender, EventArgs<List<PrintableIdByBank>> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);

                if (e.Data.Count > 0)
                {
                    List<PrintableId> pts = new List<PrintableId>();

                    View.TmpBillType = e.Data[0].BillType;
                    View.IsReprintBill = false;
                    View.PrintCondition = 99;

                    //View.TmpBillPeriod = e.Data[0].BillPeriod;

                    for (int i = 0; i < e.Data.Count; i++)
                    {
                        PrintableId pt = new PrintableId();
                        //pt.BillPeriod = e.Data[i].BillPeriod;
                        pt.BankId = e.Data[i].BankId;
                        pt.DueDate = e.Data[i].DueDate;
                        pt.FromNumberId = e.Data[i].FromCaId;
                        pt.ToNumberId = e.Data[i].ToCaId;
                        pt.LotNo = e.Data[i].BankLotNo;
                        pt.PrintingStatus = 1;
                        pts.Add(pt);
                    }

                    View.PrintId = pts;
                }
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }
        }

        /// <summary>
        /// Subscribe from GreenBillReprintPresenter
        /// </summary>
        [EventSubscription(EventTopicNames.RePrintBillByBank, Thread = ThreadOption.UserInterface)]
        public void ReprintBillByBankHandler(object sender, EventArgs<GreenBillReprintParam> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);

                View.TmpBillPeriod = e.Data.BillPeriod;
                View.TmpBillType = e.Data.BillType;
                View.IsReprintBill = true;
                View.PrintCondition = 99;

                List<PrintableId> _pts = new List<PrintableId>();
                List<PrintableIdByBank> _ptb = _printingServices.CheckExistReprintByBank(e.Data);

                for (int i = 0; i < _ptb.Count; i++)
                {
                    PrintableId _pt = new PrintableId();
                    _pt.DueDate = _ptb[i].DueDate;
                    _pt.BankId = _ptb[i].BankId;
                    _pt.CaId = _ptb[i].CaId;
                    //_pt.FromNumberId = _ptb[i].FromCaId;
                    //_pt.ToNumberId = _ptb[i].ToCaId;
                    _pt.PrintingStatus = _ptb[i].PrintingStatus;
                    _pts.Add(_pt);
                }

                View.PrintId = _pts;
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }
        }

        /// <summary>
        /// Subscribe from GreenReceiptPresenter
        /// </summary>
        [EventSubscription(EventTopicNames.PrintGreenReceipt, Thread = ThreadOption.UserInterface)]
        public void PrintGreenReceiptHandler(object sender, EventArgs<BillPrintingConditionParam> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);

                View.TmpBillPeriod = e.Data.BillPeriod;
                View.TmpBillType = e.Data.BillType;
                View.PrintCondition = e.Data.BillPrintingCondition;
                //View.HasOrgDoc = e.Data.HasOrgDoc;
                View.PrintId = _printingServices.CheckExistGreenReceipt(e.Data);
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }

        }


        /// <summary>
        /// Subscribe from GreenReceiptReprintPresenter
        /// </summary>
        [EventSubscription(EventTopicNames.ReprintGreenReceipt, Thread = ThreadOption.UserInterface)]
        public void ReprintGreenReceiptHandler(object sender, EventArgs<BillPrintingConditionParam> e)
        {
            try
            {
                BillProcessingListView rView = WorkItem.Items.Get<BillProcessingListView>("IBillProcessingListView");
                WorkItem.Workspaces[WorkspaceNames.HorizontalLayout.RightWorkspace].Show(rView);
                View.HasOrgDoc = e.Data.HasOrgDoc;
                View.TmpBillPeriod = e.Data.BillPeriod;
                View.TmpBillType = e.Data.BillType;
                View.IsReprintBill = e.Data.IsReprintBill;
                View.PrintCondition = e.Data.BillPrintingCondition;
                View.PrintId = _printingServices.CheckExistReprintGreenReceipt(e.Data);
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }
        }

        /// <summary>
        /// Print bill (A4,Blue,Green)
        /// Reprint bill (A4,Blue,Green)
        /// Condition: isReprint ? Reprint : Print
        /// </summary>
        public void PrintBill(PrintableId pt, string billPeriod, int billType, bool isReprint, string approverId, string approverName, string position, int condition)
        {
            OnWaitCursor(true);
            BillPrintingConditionParam param = new BillPrintingConditionParam();
            param.CommBranchId = Session.Branch.Id;
            param.CommBranchName = Session.Branch.Name2;
            param.PrintedBy = Session.User.Id;

            //case reprint by SEQ_NO, there is no billPred specified in UI so we have to retreive from database
            if (billPeriod == null)
                billPeriod = pt.BillPeriod;

            param.BillPeriod = billPeriod;
            param.BillType = billType;
            param.BranchId = pt.BranchId;
            param.MruId = pt.MruId;
            param.UserId = pt.CaId;
            param.FromNumberId = pt.FromNumberId;
            param.ToNumberId = pt.ToNumberId;
            param.MtNo = pt.MtNo;
            param.ApproverId = approverId;
            param.ApproverName = approverName;
            param.ApproverPosition = position;
            param.BillPrintingCondition = condition;
            param.A4Reprint = View.A4Reprint;
            param.HasOrgDoc = View.HasOrgDoc;

            //print bill by bank
            param.LotNo = pt.LotNo;
            param.BankId = pt.BankId;
            param.DueDate = pt.DueDate;



            //check printer code 
            string[] printerCode = View.GetPrinterCode();
            if ((View.GetOnPrintBillType() == "B"))
            {
                if (printerCode[1] == null || printerCode[2] == null || printerCode[3] == null || printerCode[4] == null)
                {
                    OnWaitCursor(false);
                    MessageBox.Show("กรุณาตั้งค่า Code เครื่องพิมพ์สำหรับการพิมพ์บาร์โค๊ด\nสำหรับใบแจ้งค่าไฟฟ้าผ่านตัวแทนหรือจดหน่วยแจ้งหนี้ที่วางไม่ได้\n\n", "ตั้งค่าเครื่องพิมพ์ไม่ถูกต้อง", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }
            }
            else if (View.GetOnPrintBillType() == "A")
            {
                if (printerCode[5] == null || printerCode[6] == null)
                {
                    OnWaitCursor(false);
                    MessageBox.Show("กรุณาตั้งค่า Code เครื่องพิมพ์สำหรับการพิมพ์บาร์โค๊ด\nสำหรับหนังสือแจ้งค่าไฟฟ้า\n\n", "ตั้งค่าเครื่องพิมพ์ไม่ถูกต้อง", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }
            }

            if (printerCode[1] == null)
            {
            }
            else
            {

                #region
                //"LaserMatrix",    0
                //"Fujitsu",        1
                //"Printronix",     2
                //"Data Product",   3
                //"Genicom",        4
                //"Tally",          5
                //"Pentax",         6
                if (printerCode[1].Trim() == "\x1B\x28\x42\x26\x00\x02\x02\xFD\x32\x00\x00")                       //LaserMatrix  --> EPSON     0
                {
                    param.PrinterChoice = 0;
                }
                else if (printerCode[1].Trim() == "27#20#38#82#54#11#40#1")                      //Fujitsu           1
                {
                    param.PrinterChoice = 1;
                }
                else if (printerCode[1].Trim() == "27#124#125#59#99#D#59#42")                    //Printronix        2
                {
                    param.PrinterChoice = 2;
                }
                else if (printerCode[1].Trim() == "^PN   ^T0380^M0405000 ^IBARC,C128,B,")        //Data Product      3
                {
                    param.PrinterChoice = 3;
                }
                else if (printerCode[1].Trim() == "27#[16;3;1;;;;;;;0}#27#[3t")                  //Genicom           4
                {
                    param.PrinterChoice = 4;
                }
                else if (printerCode[1].Trim() == "^PY #27#jl^M0505000^T0430^IBARC,C128,B,")     //Tally             5
                {
                    param.PrinterChoice = 5;
                }
                else if (printerCode[1].Trim() == "27#}h03080075#27#}P516")                      //Pentax            6
                {
                    param.PrinterChoice = 6;
                }
                else
                {
                    param.PrinterChoice = 4;    //default is Genicom
                }
                #endregion
            }
            

            try
            {
                //call printingService
                if (isReprint == false)
                {
                    if (billType == (int)BillType.BlueBill)
                    {
                        View.BillTxt = _printingServices.PrintBlueBill(param);
                    }
                    else if (billType == (int)BillType.GreenBill)
                    {
                        View.BillTxt = _printingServices.PrintGreenBill(param);
                    }
                    else if (billType == (int)BillType.A4Bill)
                    {
                        View.BillTxt = _printingServices.PrintA4Bill(param);
                    }
                    else if (billType == (int)BillType.GroupInvoiceA4Bill)
                    {
                        View.BillTxt = _printingServices.PrintGroupInvoiceA4Bill(param);
                    }
                    else if (billType == (int)BillType.GreenBillByBank)
                    {
                        View.BillTxt = _printingServices.PrintGreenBillByBank(param);
                    }
                    else if (billType == (int)BillType.BlueBillByBank)
                    {
                        View.BillTxt = _printingServices.PrintBlueBillByBank(param);
                    }
                    else if (billType == (int)BillType.GreenReceipt)
                    {
                        View.BillTxt = _printingServices.PrintGreenReceipt(param);
                    }
                    else if (billType == (int)BillType.SpotBill)
                    {
                        View.BillTxt = _printingServices.PrintSpotBill(param);
                    }
                }
                else
                {
                    if (billType == (int)BillType.ReprintBlueBill)
                    {
                        View.BillTxt = _printingServices.ReprintBlueBill(param);
                    }
                    else if (billType == (int)BillType.ReprintGreenBill)
                    {
                        View.BillTxt = _printingServices.ReprintGreenBill(param);
                    }
                    else if (billType == (int)BillType.ReprintGroupInvoiceA4Bill)
                    {
                        View.BillTxt = _printingServices.ReprintGroupInvoiceA4Bill(param);
                    }
                    else if (billType == (int)BillType.ReprintGreenBillByBank)
                    {
                        View.BillTxt = _printingServices.ReprintGreenBillByBank(param);
                    }
                    else if (billType == (int)BillType.ReprintBlueBillByBank)
                    {
                        View.BillTxt = _printingServices.ReprintBlueBillByBank(param);
                    }
                    else if (billType == (int)BillType.ReprintGreenReceipt)
                    {
                        View.BillTxt = _printingServices.ReprintGreenReceipt(param);
                    }
                    else if (billType == (int)BillType.ReprintSpotBill)
                    {
                        View.BillTxt = _printingServices.ReprintSpotBill(param);
                    }
                }
            }
            catch (Exception ex)
            {
                OnWaitCursor(false);
                ClientExceptionController.ShowExceptionDialog(EErrorInModule.BLAN, ex);
                //ServiceHelper.TransformErrorMessage(ex);
            }
        }

        /// <summary>
        /// This method is a placeholder that will be called by the view when it's been loaded <see cref="System.Winforms.Control.OnLoad"/>
        /// </summary>
        public override void OnViewReady()
        {
            base.OnViewReady();
        }

        /// <summary>
        /// Close the view
        /// </summary>
        public void OnCloseView()
        {
            base.CloseView();
            //View.Clear();            
        }


    }
}

